#!/bin/bash

# Phase 2.1 æ‰©å±•å®éªŒæ–¹æ¡ˆ
# 
# æ ¹æ®5ç±»pilotç»“æœ(Overall AUC=0.515):
# - ä¿¡å·å¾®å¼±ä½†ä¸€è‡´å­˜åœ¨
# - P0ä¿®å¤å®Œå…¨æœ‰æ•ˆ(5/6æŒ‡æ ‡éé€€åŒ–)
# - å»ºè®®æ‰©å±•éªŒè¯æ³›åŒ–æ€§

echo "================================================================================"
echo "Phase 2.1 æ‰©å±•å®éªŒå»ºè®®"
echo "================================================================================"
echo ""

cat << 'EOF'
å½“å‰çŠ¶æ€æ€»ç»“:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… P0ä¿®å¤æˆåŠŸ (5/5ç±»éªŒè¯é€šè¿‡):
  - Semantic indicators: çœŸå®per-prompt scoreså®ç° (éplaceholder)
  - Memory centroid: ä¿®å¤å½’ä¸€åŒ– (support setç»Ÿè®¡)
  - Entropy: å¤„ç†MAD=0é€€åŒ–æƒ…å†µ
  - æŒ‡æ ‡å¥åº·åº¦: 5/6éé€€åŒ– (ä»…extremityè®¾è®¡ç¼ºé™·)

âš ï¸ ä¿¡å·å¼ºåº¦è¯„ä¼° (5ç±»å¹³å‡):
  - Overall AUC: 0.515 (ç•¥é«˜äºéšæœº0.5)
  - Memory avg: 0.504
  - Semantic avg: 0.526
  - æœ€ä½³å•æŒ‡æ ‡: r_mem_centroid(screw)=0.664, r_sem_prompt_margin(candle)=0.831
  
ğŸ“Š ç±»åˆ«å·®å¼‚æ˜¾è‘—:
  - mvtec/capsule: Overall=0.546 (ä¸­ç­‰)
  - mvtec/screw: Overall=0.532, centroid=0.664 âœ…
  - visa/candle: Overall=0.494, prompt_margin=0.831 âœ… (åå‘!)
  - visa/capsules: Overall=0.493
  - visa/macaroni2: Overall=0.512, centroid=0.611 âœ…

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ‰©å±•æ–¹æ¡ˆå»ºè®®:

ã€æ–¹æ¡ˆA: å…¨ç±»åˆ«éªŒè¯ã€‘(æ¨è,éªŒè¯æ³›åŒ–æ€§)
  èŒƒå›´: MVTec (15ç±») + VisA (12ç±») = 27ç±»
  é…ç½®: k=4, task=cls, seed=111
  æ—¶é—´: ~3-4å°æ—¶ (å·²æœ‰checkpointçš„ç±»æ›´å¿«)
  ç›®çš„: 
    - éªŒè¯æŒ‡æ ‡åœ¨å…¨æ•°æ®é›†çš„ä¸€è‡´æ€§
    - è¯†åˆ«å“ªäº›ç±»åˆ«/åœºæ™¯ä¸‹æŒ‡æ ‡æœ‰æ•ˆ
    - ä¸ºåç»­æ–¹æ³•è®¾è®¡æä¾›æ•°æ®æ”¯æŒ
  
  è„šæœ¬: ./run_phase2_1_full_dataset.sh
  å¹¶è¡Œ: 3ä»»åŠ¡ Ã— 2çº¿ç¨‹ = é«˜æ•ˆåˆ©ç”¨å•GPU

ã€æ–¹æ¡ˆB: å¤šk-shotéªŒè¯ã€‘(æ¬¡ä¼˜å…ˆ,éªŒè¯few-shoté²æ£’æ€§)
  èŒƒå›´: å½“å‰5ç±»
  é…ç½®: k âˆˆ {1, 2, 4, 8}, task=cls
  æ—¶é—´: ~2å°æ—¶
  ç›®çš„:
    - k=1æ—¶æŒ‡æ ‡æ˜¯å¦é€€åŒ–(galleryå¤ªå°)
    - k=8æ—¶ä¿¡å·æ˜¯å¦å¢å¼º(æ›´å¤šç»Ÿè®¡)
  
  å®ç°: ä¿®æ”¹run_phase2_1_full_dataset.shçš„K_SHOTå¾ªç¯

ã€æ–¹æ¡ˆC: åˆ†å‰²ä»»åŠ¡éªŒè¯ã€‘(ä½ä¼˜å…ˆ,è¯­ä¹‰indicatorsä¸é€‚ç”¨)
  èŒƒå›´: å½“å‰5ç±»
  é…ç½®: k=4, task=seg
  æ—¶é—´: ~1-2å°æ—¶
  é—®é¢˜: 
    âš ï¸ per-prompt scoresæœªå®ç°segä»»åŠ¡
    âš ï¸ semantic indicatorsä¼šé€€åŒ–ä¸ºplaceholder
    âš ï¸ ä»…memory indicatorsæœ‰æ•ˆ
  
  å»ºè®®: è·³è¿‡,é™¤éä¿®æ”¹model.pyæ”¯æŒsegçš„per-prompt

ã€æ–¹æ¡ˆD: åœæ­¢æ‰©å±•,æ’°å†™æŠ¥å‘Šã€‘
  å¦‚æœè®¤ä¸ºAUC=0.515ä¿¡å·å¤ªå¼±,ä¸å€¼å¾—ç»§ç»­æŠ•å…¥
  ç›´æ¥æ’°å†™Phase 2.1æœ€ç»ˆæŠ¥å‘Š:
    - P0ä¿®å¤éªŒè¯æˆåŠŸ
    - å¼±ç›¸å…³æ€§è¢«è¯å®(AUC~0.51-0.55)
    - ç»“è®º: ä¸å»ºè®®åŸºäºå½“å‰indicatorsæ„å»ºgatingæ–¹æ³•
    - å»ºè®®: æ¢ç´¢å­¦ä¹ å¼æˆ–meta-learningæ–¹æ³•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ¨èè¡ŒåŠ¨:

1ï¸âƒ£ ç«‹å³æ‰§è¡Œæ–¹æ¡ˆA (å…¨ç±»åˆ«)
   ç†ç”±: 
   - æˆæœ¬ä½(3-4å°æ—¶,å¤§éƒ¨åˆ†ç±»æœ‰checkpoint)
   - æ”¶ç›Šé«˜(å®Œæ•´æ•°æ®,å¯å‘ç°æœ‰æ•ˆå­é›†)
   - 5ç±»ä¸­å‡ºç°candleçš„prompt_margin=0.831,è¯´æ˜æŸäº›ç±»åˆ«ä¿¡å·å¼º

2ï¸âƒ£ æ‰§è¡Œååˆ†æé‡ç‚¹:
   - å“ªäº›ç±»åˆ«AUC>0.6? (è¯†åˆ«"easy cases")
   - å“ªäº›æŒ‡æ ‡åœ¨å¤šæ•°ç±»åˆ«ä¸€è‡´? (é€‰æ‹©robust indicators)
   - Memory vs Semanticå“ªä¸ªæ›´ç¨³å®š?

3ï¸âƒ£ åŸºäºå…¨ç±»åˆ«ç»“æœå†³å®š:
   - è‹¥>30%ç±»åˆ«Overall AUC>0.55 â†’ è€ƒè™‘ç®€å•çº¿æ€§gating
   - è‹¥<20%ç±»åˆ«æœ‰æ•ˆ â†’ æ”¾å¼ƒreliabilityæ–¹æ³•,å†™æŠ¥å‘Š
   - è‹¥æŸæŒ‡æ ‡(å¦‚centroid)åœ¨å¤šæ•°ç±»>0.6 â†’ å•æŒ‡æ ‡gating

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å¿«é€Ÿå¯åŠ¨å‘½ä»¤:
EOF

echo ""
echo "ã€ç«‹å³æ‰§è¡Œå…¨ç±»åˆ«éªŒè¯ã€‘"
echo "cd /home/zju/codes/AD/PromptAD"
echo "./run_phase2_1_full_dataset.sh 2>&1 | tee logs/phase2_1_full.log &"
echo ""
echo "ã€ç›‘æ§è¿›åº¦ã€‘"
echo "watch -n 30 'tail -20 logs/phase2_1_full.log'"
echo ""
echo "ã€å®Œæˆååˆ†æã€‘"
echo "python phase2_1_oracle_correlation.py --use_real_data --datasets mvtec visa --k_shots 4 --task cls --result_dir result_gate"
echo "python verify_phase2_1_fixed.py"
echo ""
echo "================================================================================"
