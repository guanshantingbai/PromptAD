# Phase 2.1 å…¨æ•°æ®é›†éªŒè¯ç»“æœæŠ¥å‘Š

**æ‰§è¡Œæ—¶é—´**: 2025-12-22 21:47-21:52 (ä»…4åˆ†é’Ÿ!)  
**åˆ†æ”¯**: gate2-spatial-prompts  
**é…ç½®**: k_shot=4, task=cls, seed=111

---

## âœ… æ‰§è¡Œæ€»ç»“

- **æ•°æ®é›†**: MVTec-AD (15ç±») + VisA (12ç±») = **27ç±»**
- **æ ·æœ¬æ€»æ•°**: **12,546** ä¸ªæµ‹è¯•æ ·æœ¬
- **æ•°æ®å®Œæ•´æ€§**: 27/27 per_sample JSONæ–‡ä»¶å…¨éƒ¨ç”Ÿæˆ âœ“
- **æŒ‡æ ‡å¥åº·åº¦**: 5/6 æŒ‡æ ‡éé€€åŒ– (r_sem_extremityè®¾è®¡ç¼ºé™·é™¤å¤–)

---

## ğŸ“Š æ ¸å¿ƒå‘ç°

### 1. æ€»ä½“æ€§èƒ½

| æŒ‡æ ‡ç±»å‹ | å¹³å‡AUC | æ ‡å‡†å·® | ç»“è®º |
|---------|---------|--------|------|
| **Overall** | **0.513** | 0.041 | âš ï¸ å¾®å¼±ä½†ä¸€è‡´çš„ä¿¡å· |
| Memory | 0.529 | 0.082 | ç•¥ä¼˜äºSemantic |
| Semantic | 0.496 | 0.049 | ç•¥ä½äºéšæœº |

**è§£è¯»**: 
- ç›¸æ¯”éšæœºbaseline (0.5)ï¼ŒOverall AUCä»…æå‡0.013
- æ ‡å‡†å·®å°(0.041)è¯´æ˜ä¿¡å·è™½å¼±ä½†**åœ¨ä¸åŒç±»åˆ«é—´ä¸€è‡´å­˜åœ¨**
- MemoryæŒ‡æ ‡æ•´ä½“ä¼˜äºSemanticæŒ‡æ ‡

### 2. Oracleç»Ÿè®¡

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|------|-----|------|
| Semanticé€‰æ‹©æ¯”ä¾‹ | 45.5% Â± 31.6% | Oracleç•¥åå¥½Memoryåˆ†æ”¯ |
| Oracleå¢ç›Š | 9.6% Â± 10.0% | ç›¸æ¯”å•åˆ†æ”¯å¹³å‡æå‡9.6% |

**è§£è¯»**: 
- Oracleåœ¨å¤šæ•°æ ·æœ¬é€‰æ‹©Memoryåˆ†æ”¯ (54.5%)
- ä½†é€‰æ‹©æ¯”ä¾‹æ–¹å·®æå¤§(31.6%)ï¼Œè¯´æ˜ç±»åˆ«å·®å¼‚æ˜¾è‘—
- Oracleå¢ç›Šä¸­ç­‰(9.6%)ï¼Œè¯´æ˜åŒåˆ†æ”¯äº’è¡¥æ€§æœ‰é™

### 3. å„æŒ‡æ ‡è¯¦ç»†è¡¨ç°

| æŒ‡æ ‡ | å¹³å‡AUC | >0.6ç±»æ•° | >0.7ç±»æ•° | è¯„çº§ | æœ€ä½³æ¡ˆä¾‹ |
|------|---------|---------|---------|------|---------|
| **r_mem_centroid** | **0.646** | **15/27** | **10/27** | âœ… **æ¨è** | visa/cashew (0.972â­) |
| **r_sem_prompt_var** | **0.540** | **9/27** | **6/27** | âœ… æ¬¡é€‰ | mvtec/carpet (0.992â­) |
| r_mem_margin | 0.474 | 2/27 | 1/27 | âš ï¸ | visa/pcb3 (0.708) |
| r_mem_entropy | 0.467 | 3/27 | 0/27 | âš ï¸ | visa/cashew (0.646) |
| r_sem_prompt_margin | 0.448 | 4/27 | 1/27 | âš ï¸ | visa/candle (0.831) |
| r_sem_extremity | 0.500 | 0/27 | 0/27 | âŒ é€€åŒ– | (è®¾è®¡ç¼ºé™·) |

**å…³é”®æ´å¯Ÿ**:
- **Memory Centroid** æ˜¯å”¯ä¸€ç¨³å®šçš„æŒ‡æ ‡ (15/27ç±»>0.6)
- **Semantic Variance** åœ¨ç‰¹å®šç±»åˆ«è¡¨ç°æä¼˜ (å¦‚carpet=0.992)
- å…¶ä»–æŒ‡æ ‡é«˜åº¦ä¾èµ–ç±»åˆ«ï¼Œä¸å¤Ÿç¨³å¥

### 4. ä¿¡å·å¼ºåº¦åˆ†å¸ƒ

| ç±»åˆ« | AUCèŒƒå›´ | æ•°é‡ | æ¯”ä¾‹ | ä»£è¡¨ç±»åˆ« |
|------|---------|------|------|---------|
| ä¼˜ç§€ | â‰¥0.65 | 0 | 0.0% | - |
| è‰¯å¥½ | 0.55-0.65 | 4 | 14.8% | cashew, hazelnut, pcb3, pill |
| ä¸­ç­‰ | 0.50-0.55 | 13 | 48.1% | capsule, screw, bottleç­‰ |
| å¼± | <0.50 | 10 | 37.0% | wood, zipper, toothbrushç­‰ |

**è§£è¯»**:
- **æ— ä»»ä½•ç±»åˆ«Overall AUCè¶…è¿‡0.65** (å¼ºç›¸å…³é˜ˆå€¼)
- ä»…14.8%ç±»åˆ«è¾¾åˆ°"è‰¯å¥½"æ°´å¹³ (0.55-0.65)
- è¿‘ä¸€åŠç±»åˆ«(48.1%)ä¿¡å·ä¸­ç­‰ (0.50-0.55)
- è¶…è¿‡1/3ç±»åˆ«(37%)ä¿¡å·å¼±äºéšæœº

### 5. æ•°æ®é›†å¯¹æ¯”

| æ•°æ®é›† | ç±»æ•° | å¹³å‡AUC | æ ‡å‡†å·® | ç»“è®º |
|--------|------|---------|--------|------|
| **MVTec** | 15 | **0.521** | 0.032 | ç•¥ä¼˜ï¼Œæ›´ä¸€è‡´ |
| **VisA** | 12 | **0.502** | 0.049 | æ›´æ¥è¿‘éšæœº |

**è§£è¯»**:
- MVTecç±»åˆ«é—´æ›´ä¸€è‡´ (std=0.032)
- VisAç±»åˆ«å·®å¼‚æ›´å¤§ (std=0.049)
- ä¸¤æ•°æ®é›†æ•´ä½“éƒ½æ˜¯å¾®å¼±ä¿¡å·

---

## ğŸ† Top 5 ç±»åˆ« (Overall AUC)

1. **visa/cashew** (AUC=0.604) - æœ€ä½³! centroid=0.972â­
2. **mvtec/hazelnut** (AUC=0.576) - centroid=0.894
3. **visa/pcb3** (AUC=0.573) - margin=0.708
4. **mvtec/pill** (AUC=0.573) - centroid=0.829
5. **mvtec/capsule** (AUC=0.546) - prompt_var=0.591

---

## âš¡ å•æŒ‡æ ‡æœ€ä½³è¡¨ç°

| æŒ‡æ ‡ | æœ€ä½³ç±»åˆ« | AUC | æ„ä¹‰ |
|------|---------|-----|------|
| Memory Centroid | **visa/cashew** | **0.972** â­â­â­ | æ¥è¿‘å®Œç¾é¢„æµ‹! |
| Semantic Variance | **mvtec/carpet** | **0.992** â­â­â­ | æ¥è¿‘å®Œç¾é¢„æµ‹! |
| Semantic Margin | **visa/candle** | **0.831** â­â­ | å¼ºç›¸å…³ |
| Memory Margin | **visa/pcb3** | **0.708** â­ | ä¸­ç­‰ç›¸å…³ |
| Memory Entropy | visa/cashew | 0.646 | å¼±-ä¸­ç­‰ |

**å…³é”®å‘ç°**: 
- åœ¨**ç‰¹å®šç±»åˆ«**ä¸Šï¼Œå•ä¸ªæŒ‡æ ‡å¯ä»¥è¾¾åˆ°**æ¥è¿‘å®Œç¾çš„é¢„æµ‹èƒ½åŠ›** (AUC>0.97)!
- ä½†è¿™äº›é«˜æ€§èƒ½æ¡ˆä¾‹**ä¸å…·å¤‡æ³›åŒ–æ€§**ï¼Œæ¯ä¸ªç±»åˆ«æœ€ä¼˜æŒ‡æ ‡ä¸åŒ

---

## ğŸ¯ ç»“è®ºä¸å»ºè®®

### ä¸»è¦ç»“è®º

1. **âœ… P0ä¿®å¤å®Œå…¨æˆåŠŸ**
   - æ‰€æœ‰æŒ‡æ ‡æ­£å¸¸å·¥ä½œ (5/6éé€€åŒ–)
   - Per-prompt scoreså®ç°æ­£ç¡®
   - Support set normalizationæœ‰æ•ˆ

2. **âš ï¸ ä¿¡å·å¾®å¼±ä½†ä¸€è‡´**
   - Overall AUC=0.513 (ç•¥é«˜äºéšæœº0.5)
   - æ ‡å‡†å·®å°(0.041)ï¼Œè·¨ç±»åˆ«ä¸€è‡´æ€§å¥½
   - ä½†**ä¸è¶³ä»¥æ”¯æ’‘å®ç”¨çš„gatingç­–ç•¥**

3. **ğŸ“ˆ ç±»åˆ«ä¾èµ–æ€§å¼º**
   - æœ€å¥½ç±»åˆ«(cashew) vs æœ€å·®ç±»åˆ«(zipper): 0.604 vs 0.423
   - å•æŒ‡æ ‡æœ€ä½³æ¡ˆä¾‹å¯è¾¾AUC>0.97ï¼Œä½†ä¸æ³›åŒ–
   - MVTecç•¥ä¼˜äºVisA (0.521 vs 0.502)

4. **ğŸ” æŒ‡æ ‡æ´å¯Ÿ**
   - **Memory Centroid**: æœ€ç¨³å¥ (15/27ç±»>0.6)
   - **Semantic Variance**: å°‘æ•°ç±»åˆ«æä¼˜ (6ç±»>0.7)
   - å…¶ä»–æŒ‡æ ‡: é«˜åº¦ä¾èµ–ç±»åˆ«ï¼Œä¸æ¨è

### å¯¹äºPhase 2çš„å»ºè®®

#### æ–¹æ¡ˆA: åœæ­¢å½“å‰è·¯çº¿ â­ (æ¨è)

**ç†ç”±**:
- Overall AUC=0.513è¿œä½äºå®ç”¨é˜ˆå€¼(é€šå¸¸éœ€>0.70)
- ä»…4/27ç±»åˆ«è¾¾åˆ°"è‰¯å¥½"æ°´å¹³(0.55-0.65)
- å³ä½¿æœ€å¥½çš„ç±»åˆ«ä¹Ÿä»…AUC=0.604

**è¡ŒåŠ¨**:
1. æ’°å†™Phase 2.1ç ”ç©¶æŠ¥å‘Šï¼Œè®°å½•å‘ç°
2. æ¢ç´¢**å­¦ä¹ å¼gatingæ–¹æ³•** (meta-learning, ç¥ç»ç½‘ç»œæƒé‡)
3. è€ƒè™‘**å…¶ä»–priorä¿¡æ¯** (å¦‚few-shotæ ·æœ¬å†…éƒ¨ä¸€è‡´æ€§)

#### æ–¹æ¡ˆB: é™å®šåœºæ™¯åº”ç”¨ (å¤‡é€‰)

**é€‚ç”¨æ¡ä»¶**:
- ä»…åœ¨cashew/hazelnut/pcb3/pillç­‰"è‰¯å¥½"ç±»åˆ«ä½¿ç”¨
- ä»…ä½¿ç”¨Memory CentroidæŒ‡æ ‡ (æœ€ç¨³å¥)
- æ¥å—ä½å¢ç›Š (é¢„æœŸæå‡<5% AUROC)

**å®ç°**:
```python
if r_mem_centroid > threshold:
    use memory_branch
else:
    use semantic_branch
```
- åœ¨4ä¸ªè‰¯å¥½ç±»åˆ«æµ‹è¯•é˜ˆå€¼
- è¯„ä¼°å®é™…AUROCæå‡

#### æ–¹æ¡ˆC: ç»„åˆä¼˜åŒ– (æ¿€è¿›)

**å‡è®¾**: 
- å¤šæŒ‡æ ‡çº¿æ€§ç»„åˆå¯èƒ½å¢å¼ºä¿¡å·

**å®ç°**:
```python
reliability = w1*r_mem_centroid + w2*r_sem_prompt_var
```
- åœ¨4ä¸ªè‰¯å¥½ç±»åˆ«å­¦ä¹ æƒé‡ w1, w2
- Cross-validationéªŒè¯
- **é£é™©**: å¯èƒ½è¿‡æ‹Ÿåˆï¼Œä¸å»ºè®®

### åç»­ç ”ç©¶æ–¹å‘

1. **Meta-Learning Gating**
   - åœ¨support setä¸Šå­¦ä¹ per-sampleæƒé‡
   - ä½¿ç”¨å°å‹MLPç½‘ç»œé¢„æµ‹gating
   - è¾“å…¥: [memory_score, semantic_score, 6ä¸ªindicators]

2. **Uncertainty-based Gating**
   - Monte Carlo Dropoutä¼°è®¡ä¸ç¡®å®šæ€§
   - Temperature scalingè°ƒæ•´confidence
   - ä½¿ç”¨uncertaintyä½œä¸ºgatingä¿¡å·

3. **Few-shot Consistency**
   - åˆ©ç”¨support setæ ·æœ¬é—´å…³ç³»
   - è®¡ç®—queryä¸supportçš„ç›¸ä¼¼åº¦åˆ†å¸ƒ
   - æ£€æµ‹"ç¦»ç¾¤"query (è¿œç¦»supportçš„æ ·æœ¬)

4. **Task-Adaptive Indicators**
   - ä¸ºsegä»»åŠ¡é‡æ–°è®¾è®¡æŒ‡æ ‡
   - Spatial consistency indicators
   - Per-pixel reliability estimation

---

## ğŸ“ è¾“å‡ºæ–‡ä»¶

æ‰€æœ‰ç»“æœä¿å­˜åœ¨ `result/gate2/phase2_1_analysis/`:

- `oracle_selection_summary.csv` - Oracleé€‰æ‹©ç»Ÿè®¡
- `indicator_auc_results.csv` - å„æŒ‡æ ‡AUCè¯¦æƒ…
- `hard_cases_summary.csv` - å›°éš¾æ ·æœ¬åˆ†æ
- `oracle_selection_histogram.png` - Oracleé€‰æ‹©åˆ†å¸ƒå›¾

Per-sampleæ•°æ®: `result_gate/{dataset}/k_4/per_sample/cls/{class}_seed111_per_sample.json`

---

## âœ¨ è‡´è°¢

æ„Ÿè°¢ä¸¥æ ¼çš„è‡ªæˆ‘æ£€æŸ¥æµç¨‹ï¼ŒæˆåŠŸå‘ç°å¹¶ä¿®å¤äº†3ä¸ªP0çº§åˆ«bug:
1. Sample trackingé”™è¯¯ (batch_idx â†’ sample_counter)
2. Semantic branch checkpointåŠ è½½ç¼ºå¤± (build_text_feature_gallery)
3. Semantic reliability placeholderå®ç°
4. Memory centroidå½’ä¸€åŒ–é”™è¯¯
5. Entropy MAD=0é€€åŒ–å¤„ç†

è¿™äº›ä¿®å¤ç¡®ä¿äº†åˆ†æçš„ç§‘å­¦æ€§å’Œå¯é æ€§ï¼

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-22 22:00  
**åˆ†æè„šæœ¬**: `phase2_1_oracle_correlation.py`  
**éªŒè¯è„šæœ¬**: `verify_phase2_1_fixed.py`
