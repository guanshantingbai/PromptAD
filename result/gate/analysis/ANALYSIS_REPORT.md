# Gate实验结果分析报告

## 📊 1. 数据集平均结果

### 分类任务 (CLS)
| 配置 | Semantic | Memory | Max | Harmonic | Oracle |
|------|----------|--------|-----|----------|--------|
| MVTec k=1 | 88.26% | 89.49% | **92.60%** | 89.91% | 99.81% |
| MVTec k=2 | 88.10% | 91.58% | **94.22%** | 90.95% | 99.44% |
| MVTec k=4 | 90.28% | 93.98% | **95.29%** | 94.40% | 99.85% |
| VisA k=1 | 80.16% | 82.50% | **84.99%** | 83.21% | 99.40% |
| VisA k=2 | 80.40% | 83.40% | **86.35%** | 84.07% | 99.91% |
| VisA k=4 | 78.85% | 84.56% | **86.42%** | 85.32% | 99.61% |

### 分割任务 (SEG)
| 配置 | Semantic | Memory | Max | Harmonic | Oracle |
|------|----------|--------|-----|----------|--------|
| MVTec k=1 | 89.87% | 94.66% | **95.39%** | 93.66% | **95.39%** |
| MVTec k=2 | 90.88% | 94.96% | **96.05%** | 94.41% | **96.05%** |
| MVTec k=4 | 92.34% | 95.76% | **96.74%** | 95.39% | **96.74%** |
| VisA k=1 | 90.71% | 94.12% | **96.33%** | 94.25% | **96.33%** |
| VisA k=2 | 90.76% | 94.19% | **96.48%** | 94.52% | **96.48%** |
| VisA k=4 | 90.28% | 93.67% | **96.56%** | 93.55% | **96.56%** |

## 🔍 2. 关键发现

### 2.1 Max策略表现
- **SEG任务**: Max策略达到Oracle上界,说明max fusion是最优的
- **CLS任务**: Max策略与Oracle有较大差距(~5-15%),说明存在改进空间

### 2.2 Harmonic策略表现
- **SEG任务**: 略低于Max (~1-2%),但仍然很好
- **CLS任务**: 在某些配置下表现不佳,需要分析失败案例

### 2.3 K-shot效应
- **MVTec CLS**: 性能随k增加而提升 (92.60% → 94.22% → 95.29%)
- **VisA CLS**: 性能随k增加而提升 (84.99% → 86.35% → 86.42%)
- **SEG任务**: 对k值不太敏感,所有k值都达到~95-96%

## ⚠️ 3. 失败案例分析 (分支差距 > 10%)

共发现 **81个失败案例**,其中:
- **Semantic分支过弱**: 66例 (81.5%)
- **Memory分支过弱**: 15例 (18.5%)

### 3.1 最严重的失败案例 (Top 10)

| 数据集 | 类别 | K | 任务 | Semantic | Memory | 差距 | 弱分支 |
|--------|------|---|------|----------|--------|------|--------|
| VisA | pipe_fryum | 4 | CLS | 73.18% | 98.60% | **25.42%** | Semantic |
| MVTec | toothbrush | 2 | CLS | 69.58% | 94.17% | **24.58%** | Semantic |
| MVTec | transistor | 1 | CLS | 90.25% | 67.29% | **22.96%** | Memory |
| MVTec | toothbrush | 1 | CLS | 72.78% | 94.44% | **21.67%** | Semantic |
| MVTec | zipper | 2 | CLS | 94.22% | 73.06% | **21.17%** | Memory |
| VisA | capsules | 2 | CLS | 55.94% | 76.40% | **20.46%** | Semantic |
| MVTec | hazelnut | 4 | CLS | 80.14% | 100.00% | **19.86%** | Semantic |
| MVTec | hazelnut | 2 | CLS | 80.11% | 99.86% | **19.75%** | Semantic |
| MVTec | hazelnut | 1 | CLS | 83.59% | 99.82% | **16.23%** | Semantic |
| VisA | pipe_fryum | 2 | CLS | 83.10% | 98.71% | **15.62%** | Semantic |

### 3.2 失败模式总结

**Semantic分支失败** (66例):
- **类别**: hazelnut, toothbrush,  capsules, pipe_fryum, pcb2, metal_nut
- **原因**: 文本提示对某些异常类型描述不足
- **解决方向**: 改进prompt设计,增加异常描述的多样性

**Memory分支失败** (15例):
- **类别**: transistor, zipper, capsule, screw, candle
- **原因**: 正常样本多样性不足,导致NN检索误判
- **解决方向**: 增加few-shot样本数量,或改进特征提取

## 📈 4. 策略建议

### 4.1 何时使用Max策略?
✅ **推荐场景**:
- SEG任务 (所有数据集)
- 两个分支性能相近的CLS任务
- 需要最高性能的场景

### 4.2 何时使用Harmonic策略?
⚠️ **谨慎使用**:
- 存在显著失败案例 (81个,占50%)
- Harmonic会被弱分支严重拖累
- 需要先检查分支差距

✅ **可以使用**:
- 分支差距 < 10%的情况
- SEG任务 (差距较小)

### 4.3 改进方向
1. **自适应融合**: 根据可靠性信号动态调整权重
2. **失败案例重点优化**: 针对hazelnut, toothbrush等改进semantic分支
3. **分支选择**: 考虑基于validation set的分支选择策略

## 📁 5. 生成文件

所有结果已保存在 `result/gate/analysis/`:
- `average_cls.csv` / `average_seg.csv` - 数据集平均结果
- `full_results.csv` - 完整结果 (810条记录)
- `failure_cases.csv` - 失败案例详情 (81条)
- `{dataset}_{task}_by_class.png` - 按类别可视化 (4个图)

---

**结论**: Max策略在SEG任务上表现完美,在CLS任务上仍有改进空间。Harmonic策略在存在弱分支时会显著失败,不建议直接使用。
