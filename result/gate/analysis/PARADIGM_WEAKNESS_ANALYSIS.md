# PromptAD范式弱点分析

基于162个gate实验（MVTec + VisA，k=1/2/4，CLS+SEG任务）的系统性分析。

---

## 核心发现

### 1. **Semantic分支整体偏弱**（CLS任务）

- **Memory分支平均AUROC: 88.04%**
- **Semantic分支平均AUROC: 84.85%**
- **平均性能差距: 7.66%**
- **Memory占优: 48.1%的任务**
- **Semantic占优: 51.9%的任务**（但差距较小）

### 2. **K-shot增加，差距不缩小**

| K-shot | Semantic AUROC | Memory AUROC | 差距 |
|--------|----------------|--------------|------|
| 1      | 84.66%         | 86.39%       | 7.17% |
| 2      | 84.67%         | 87.94%       | 8.47% |
| 4      | 85.20%         | 89.80%       | 7.35% |

**结论**: 增加few-shot样本数对**Semantic分支提升有限**，表明文本prompt学习存在瓶颈。

### 3. **VisA数据集更难**

| 数据集 | Semantic AUROC | Memory AUROC | 差距 |
|--------|----------------|--------------|------|
| MVTec  | 88.88%         | 91.68%       | 2.80% |
| VisA   | 79.80%         | 83.49%       | 3.69% |

**结论**: VisA数据集的工业场景更复杂，两个分支都下降，但Semantic分支下降更多（-9.08% vs -8.19%）。

---

## 系统性弱分支类别（跨所有K-shot一致表现差）

### MVTec CLS - Semantic弱类别

| 类别 | 平均Semantic | 平均Memory | 差距 | 特征 |
|------|--------------|------------|------|------|
| **toothbrush** | 75.6% | 95.3% | **19.7%** | 形状变化大，颜色不明显 |
| **hazelnut** | 81.3% | 99.9% | **18.6%** | 纹理异常为主，颜色单一 |
| **metal_nut** | 86.9% | 99.4% | **12.5%** | 表面划痕，光照变化大 |

### VisA CLS - Semantic弱类别

| 类别 | 平均Semantic | 平均Memory | 差距 | 特征 |
|------|--------------|------------|------|------|
| **pipe_fryum** | 81.4% | 98.8% | **17.4%** | 管状食品，形状不规则 |
| **capsules** | 57.9% | 73.6% | **15.7%** | 药片，颜色丰富，形状多样 |
| **pcb2** | 64.2% | 76.2% | **12.0%** | 电路板，复杂结构 |

---

## 范式弱点总结

### **弱点1: Semantic分支在纹理/结构异常上表现差**

**原因分析**:
- 文本prompt难以精确描述**细粒度纹理特征**（如划痕、裂纹、纹理不均）
- CLIP的文本编码器对**视觉细节描述能力有限**
- Few-shot样本不足以让模型学习到有效的异常描述

**影响类别**:
- hazelnut（榛子表面纹理）
- metal_nut（金属划痕）
- toothbrush（刷毛纹理）
- pcb2（电路走线）

### **弱点2: Semantic分支在形状多样性高的类别上失效**

**原因分析**:
- 文本prompt倾向于学习**类别级别的描述**（"a photo of hazelnut"）
- 当正常样本形状变化大时，很难用**统一的文本描述**区分正常/异常
- Memory分支通过NN检索可以适应形状变化

**影响类别**:
- toothbrush（牙刷形状多样）
- pipe_fryum（管状食品弯曲不规则）
- capsules（药片颜色/形状组合多样）

### **弱点3: K-shot增加对Semantic分支帮助有限**

**原因分析**:
- Semantic分支优化的是**可学习的文本prompt embedding**
- 文本空间维度相比视觉空间有限（CLIP text encoder维度512 vs vision 768）
- **训练信号瓶颈**: 只通过few-shot的对比学习损失优化prompt，信息量不足

**实验证据**:
- K=1→4，Semantic仅提升 **0.54%**（84.66→85.20）
- K=1→4，Memory提升 **3.41%**（86.39→89.80）
- Memory对样本数更敏感，Semantic接近饱和

---

## 应用于Baseline的价值

### **1. 可以解释原始PromptAD的性能上限**

原论文报告的AUROC可能是**Max融合**的结果，本质上是**Memory分支主导**的性能。

- Max融合在CLS上平均90.43%，接近Memory单分支的88.04%
- Semantic分支贡献有限（仅在少数类别上占优）

### **2. 指出改进方向**

基于弱点分析，可以提出针对性改进：

**方向1: 增强文本描述能力**
- 使用**多层次prompt**（全局+局部纹理描述）
- 引入**视觉特征引导的prompt生成**（用visual feature生成更精确的文本描述）

**方向2: 改进训练策略**
- 增加**更多的异常样本用于prompt学习**（目前只用few-shot normal样本）
- 使用**伪标签扩展训练集**（用memory分支的预测辅助semantic分支训练）

**方向3: 自适应融合**
- 不用固定的Max融合，而是学习**类别相关的融合权重**
- 对纹理类异常增加memory权重，对语义类异常增加semantic权重

### **3. 作为消融实验的理论支撑**

如果要发表论文改进PromptAD，这个分析可以：
- 解释为什么需要改进Semantic分支
- 证明Memory分支已接近上限（100%时Oracle也只能到99%）
- 为提出的新方法提供动机（"we observe that semantic branch systematically underperforms on texture-based anomalies..."）

---

## 最差案例分析

### 单个最差：VisA capsules（差距29.5%）

```
K=4, SEG任务
Max融合: 95.63%
Harmonic融合: 66.10%
差距: 29.53%
```

**但注意**: SEG任务没有分支数据，这个差距来自harmonic vs max的融合差异，不能直接反映分支弱点。

### CLS任务最差：VisA pipe_fryum K=4

```
Semantic: 73.18%
Memory: 98.60%
差距: 25.42%
```

**原因**: 管状食品表面纹理复杂且不规则，文本难以描述，但Memory可以通过NN找到相似的正常样本。

---

## 结论

**PromptAD的核心限制在于Semantic分支**，具体体现在：

1. **纹理/结构异常检测能力弱**（相比Memory低5-20%）
2. **对Few-shot样本数不敏感**（K=1→4仅提升0.54%）
3. **在复杂场景（VisA）下降更明显**（-9.08% vs MVTec）

这些弱点可以作为**改进PromptAD的动机**和**新方法的对比基线**。建议未来工作重点增强文本-视觉对齐能力，或引入混合专家机制让两个分支各司其职。
